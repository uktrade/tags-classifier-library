version: 2.1

job_defaults: &job_defaults
  parameters:
    python_image:
      type: string

    publish_coverage:
      type: boolean
      default: false

  working_directory: ~/app

  docker:
    - image: <<parameters.python_image>>


jobs:
  code_quality_checks:
    docker:
      - image: circleci/python:3.8.3
    steps:
      - checkout
      - restore_cache:
          keys:
            - pip-dependencies-{{ checksum "requirements-dev.txt" }}
      - run:
          name: Create virtualenv and install dependencies
          command: |
              python3 -m venv env
              . env/bin/activate
              pip install -r requirements-dev.txt
      - run:
          name: Run code quality checks
          command: |
            source env/bin/activate
            make checks
      - save_cache:
          paths:
            - env
          key: pip-dependencies-{{ checksum "requirements-dev.txt" }}

workflows:
  version: 2
  run_tests:
    jobs:
      - code_quality_checks
